<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Neko Claim</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f0f2f5;
      }
      .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 400px;
      }
      .logo {
        width: 150px;
        height: auto;
        margin-bottom: 20px;
        border-radius: 10px;
      }
      h1 {
        color: #333;
        margin-bottom: 20px;
      }
      button {
        background-color: #4c74af;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px 0;
        width: 100%;
        transition: background-color 0.3s;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      #status {
        margin-top: 15px;
        color: #666;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <img src="logo.png" alt="Neko Token Logo" class="logo" />
      <h1>Neko Claim</h1>
      <button id="connectWallet">Connect Wallet</button>
      <div id="status"></div>
    </div>

    <script>
      // Konfigurasi Kontrak
      const nekoAirdropAddress = "0x63a8E62B8C0A11780d6408fAbf53cED88848D9e8";
      const tokenAddresses = [
        "0x9999980d9bda7A4330e96A95BAd74B316a76F482",
        "0x11111181058C2C2c493eA5C4B7DB2694A7A8E451",
        "0x99879733435CB2AcDEB8faaeC43acB0130E4f4aA",
        "0xC7F7d926439eC08C9c8d91dc25538ed01752d637",
        "0x1a378047dbF8a4B6cD96Cd92A555BAbe3E11CC62",
        "0x1bA0faC06683E4CeE5720440B3f0b37a8bAB1575",
        "0x1111122D311539db123784b771D3382853E69B60",
      ];

      const nekoAirdropABI = [
        {
          inputs: [],
          name: "claimTokens",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "address",
              name: "claimer",
              type: "address",
            },
          ],
          name: "hasClaimed",
          outputs: [
            {
              internalType: "bool",
              name: "",
              type: "bool",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "address",
              name: "account",
              type: "address",
            },
          ],
          name: "whitelist",
          outputs: [
            {
              internalType: "bool",
              name: "",
              type: "bool",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
      ];

      const tokenABI = [
        {
          inputs: [
            {
              internalType: "address",
              name: "account",
              type: "address",
            },
          ],
          name: "balanceOf",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
      ];

      let web3;
      let nekoAirdropContract;
      let userAccount;

      const connectWalletBtn = document.getElementById("connectWallet");
      const statusDiv = document.getElementById("status");

      // Tambahkan fungsi untuk mengecek koneksi wallet saat halaman dimuat
      async function checkWalletConnection() {
        if (window.ethereum) {
          web3 = new Web3(window.ethereum);
          const accounts = await web3.eth.getAccounts();

          if (accounts.length > 0) {
            userAccount = accounts[0];
            nekoAirdropContract = new web3.eth.Contract(
              nekoAirdropABI,
              nekoAirdropAddress
            );

            connectWalletBtn.textContent = "Claim Tokens";
            handleConnection();
          }
        }
      }

      async function handleConnection() {
        console.log("Connected address:", userAccount);
        statusDiv.textContent = `Connected: ${userAccount}`;

        const isWhitelisted = await nekoAirdropContract.methods
          .whitelist(userAccount)
          .call();

        if (!isWhitelisted) {
          statusDiv.textContent = `${userAccount}\n Not Whitelisted - You are not eligible for the airdrop`;
          connectWalletBtn.disabled = true;
          return;
        }

        const hasClaimed = await nekoAirdropContract.methods
          .hasClaimed(userAccount)
          .call();

        if (hasClaimed) {
          statusDiv.textContent = `${userAccount}\n Already Claimed`;
          connectWalletBtn.disabled = true;
        } else {
          statusDiv.textContent = `${userAccount}\n Whitelisted - Click to claim your tokens`;
          connectWalletBtn.onclick = claimTokens;
        }
      }

      connectWalletBtn.onclick = connectWallet;

      async function connectWallet() {
        if (window.ethereum) {
          try {
            await window.ethereum.request({
              method: "wallet_requestPermissions",
              params: [
                {
                  eth_accounts: {},
                },
              ],
            });

            web3 = new Web3(window.ethereum);
            const accounts = await window.ethereum.request({
              method: "eth_requestAccounts",
            });

            userAccount = accounts[0];
            nekoAirdropContract = new web3.eth.Contract(
              nekoAirdropABI,
              nekoAirdropAddress
            );

            connectWalletBtn.textContent = "Claim Tokens";
            handleConnection();
          } catch (error) {
            statusDiv.textContent = "Failed to connect: " + error.message;
            console.error(error);
          }
        } else {
          statusDiv.textContent =
            "MetaMask not detected. Please install MetaMask first.";
        }
      }

      async function claimTokens() {
        if (!nekoAirdropContract) {
          statusDiv.textContent = "Please connect wallet first";
          return;
        }

        try {
          statusDiv.textContent = "Claiming tokens...";
          connectWalletBtn.disabled = true;

          const tx = await nekoAirdropContract.methods.claimTokens().send({
            from: userAccount,
            gas: 300000,
            gasPrice: await web3.eth.getGasPrice(),
          });

          const txHash = tx.transactionHash;
          const sepoliaUrl = `https://sepolia.etherscan.io/tx/${txHash}`;
          statusDiv.innerHTML = `
            Tokens claimed successfully!<br><br>
            <a href="${sepoliaUrl}" target="_blank" style="color: #4c74af; text-decoration: underline;">
              View transaction on Sepolia Etherscan
            </a>
          `;
          connectWalletBtn.disabled = true;
        } catch (error) {
          statusDiv.textContent = "Token claim failed: " + error.message;
          connectWalletBtn.disabled = false;
          console.error(error);
        }
      }

      // Check wallet connection on page load
      checkWalletConnection();

      // Detect MetaMask account changes
      if (window.ethereum) {
        window.ethereum.on("accountsChanged", (accounts) => {
          if (accounts.length > 0) {
            userAccount = accounts[0];
            connectWalletBtn.textContent = "Claim Tokens";
            handleConnection();
          } else {
            connectWalletBtn.textContent = "Connect Wallet";
            statusDiv.textContent = "";
          }
        });
      }
    </script>
  </body>
</html>
